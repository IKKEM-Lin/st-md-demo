<html>
  <head>
    <script src="https://unpkg.com/ngl@2.2.2/dist/ngl.js"></script>
  </head>
  <body>
    <div style="position: relative;">
        <div id="viewport" style="width:100%; height:400px;"></div>
        <div id="legend" style="position: absolute;bottom: 0;right: 0;padding: 8px;display: flex;flex-direction: column;gap: 4px; border: 1px solid #ddd; border-radius: 4px;background-color: #ffffffcc; max-height: 300px; overflow-y: auto;"></div>
    </div>
    <div style="margin-top:12px;display:flex; align-items:center">
      <div id="playBtn" style="padding:4px"></div>
      <input id="slider" type="range" style="flex-grow:1" value="0" min="0" />
    </div>
    <script>
        const playIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:24px"><path fill-rule="evenodd" d="M4.5 5.653c0-1.427 1.529-2.33 2.779-1.643l11.54 6.347c1.295.712 1.295 2.573 0 3.286L7.28 19.99c-1.25.687-2.779-.217-2.779-1.643V5.653Z" clip-rule="evenodd" /></svg>'

        const pauseIcon = '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" style="width:24px"><path fill-rule="evenodd" d="M6.75 5.25a.75.75 0 0 1 .75-.75H9a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H7.5a.75.75 0 0 1-.75-.75V5.25Zm7.5 0A.75.75 0 0 1 15 4.5h1.5a.75.75 0 0 1 .75.75v13.5a.75.75 0 0 1-.75.75H15a.75.75 0 0 1-.75-.75V5.25Z" clip-rule="evenodd" /></svg>'

        let player;
        let playStatus = false;

        const $$playBtn = document.getElementById("playBtn")
        const $$slider = document.getElementById("slider")
        const $$legend = document.getElementById("legend")

        const handlePlayStatusChange = (status) => {
        playStatus = status;
        if (playStatus) {
            $$playBtn.innerHTML = pauseIcon;
        } else {
            $$playBtn.innerHTML = playIcon;
        }
        }

        const handlePlayFrameChange = (value, max) => {
            // console.log(value, max, $$slider.max)
            $$slider.value = value;
            $$slider.setAttribute('max', max)
        }

        const handleSliderChange = (evt) => {
            const value = evt.target.value;
            if (!player) {
                return;
            }
            // console.log(player.traj.currentFrame, value)
            if (player.traj.currentFrame !== value) {
                player.traj.setFrame(value);
            }
        }

        const handlePlayBtnClick = () => {
            // console.log({playStatus})
            if (playStatus) {
                
                player.pause();
                handlePlayStatusChange(false)
            } else {
                player.play();
                handlePlayStatusChange(true)
            }
        }

        $$playBtn.addEventListener("click", handlePlayBtnClick);
        $$slider.addEventListener("input", handleSliderChange);
        $$slider.addEventListener("mousedown", () => {
        if (player) {
            player.pause();
        }
        });
        $$slider.addEventListener("mouseup", () => {
        if (player && playStatus) {
            player.play();
        }
        });

      const stage = new NGL.Stage("viewport", {
        backgroundColor: "$BACKGROUND_COLOR",
        clipMode: "camera",
        clipScale: "absolute",
        clipNear: 0.01,
        clipFar: 100000,
        fogNear: 0.01,
        fogFar: 100000,
        });

      window.addEventListener( "resize", function( event ){
            stage.handleResize();
      }, false );

      const legendItemRender = (atom) => `<div style="display: flex; gap: 16px; align-items: center;">
        <div style="width: 16px; height: 16px; border-radius: 8px; box-shadow: 0 1px 2px 1px #aaa; background-color: $${atom.color};"></div>
        <div>$${atom.element}</div>
      </div>`

      stage.loadFile("$STRUCTURE_URL").then(function (o) {
        o.addRepresentation("ball+stick") //, {radiusType: "covalent"});
        o.autoView();

        o.structure.atomMap.list.sort((a,b) => a.number > b.number ? 1 : -1)
        const atomColorMap = o.structure.atomMap.list.map(item => {
            const element = item.element;
            const color = "#" + NGL.ColormakerRegistry.getScheme({scheme: "element"}).atomColor(item).toString(16);
            return {element, color}
        })

        $$legend.innerHTML=`$${atomColorMap.map(atom => legendItemRender(atom)).join("")}`

        // console.log(o, atomColorMap)
        // console.log(NGL.ColormakerRegistry.getScheme({scheme: "element"}).atomColor(o.structure.atomMap.list[0]))

        NGL.autoLoad("$TRAJ_URL").then(function (frames) {
          const traj = o.addTrajectory(frames).trajectory;
          player = new NGL.TrajectoryPlayer(traj, {
            step: 1,
            timeout: 90,
            interpolateStep: 16,
            start: 0,
            end: traj.numframes,
            interpolateType: "linear",
            mode: "$PLAY_MODE",
            // direction: "bounce",
          });
          handlePlayStatusChange(false)
          if ($AUTO_PLAY) {
            player.play();
            handlePlayStatusChange(true)
          }
          player.traj.signals.frameChanged.add(value => {
            handlePlayFrameChange(value, frames.coordinates.length - 1)
          });
        });
      });
    </script>
  </body>
</html>